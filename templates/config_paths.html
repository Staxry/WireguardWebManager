{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π - WireGuard Management{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h1>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º</h1>
        <p>–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º –∏ —Ñ–∞–π–ª–∞–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π WireGuard</p>
    </div>

    <div class="config-section">
        <h2>üìÅ –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="current-paths">
            <div class="path-item">
                <strong>–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:</strong>
                <code>{{ current_client_path }}</code>
                <a href="{{ url_for('browse_directory', path=current_client_path) }}" class="btn btn-sm btn-outline">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
            </div>
            <div class="path-item">
                <strong>–°–µ—Ä–≤–µ—Ä–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong>
                <code>{{ current_server_path }}</code>
                <a href="{{ url_for('browse_directory', path=current_server_path|dirname) }}" class="btn btn-sm btn-outline">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
            </div>
        </div>
    </div>

    <div class="config-section">
        <h2>üîç –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</h2>
        <div class="quick-scan">
            <button onclick="scanCommonPaths()" class="btn btn-primary">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏</button>
            <div id="scan-results" class="scan-results"></div>
        </div>
    </div>

    <div class="config-section">
        <h2>üìÇ –ò–∑–º–µ–Ω–∏—Ç—å –ø—É—Ç–∏</h2>
        
        <div class="path-config">
            <h3>–ü—É—Ç—å –∫ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º</h3>
            <form method="POST" action="{{ url_for('set_config_path') }}" class="path-form">
                <input type="hidden" name="path_type" value="client">
                <div class="input-group">
                    <input type="text" name="path" value="{{ current_client_path }}" placeholder="/root/" class="form-control">
                    <button type="button" onclick="browseForPath('client')" class="btn btn-outline">–û–±–∑–æ—Ä</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <small class="help-text">–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ñ–∞–π–ª—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /root/, /home/user/wireguard/)</small>
            </form>
        </div>

        <div class="path-config">
            <h3>–ü—É—Ç—å –∫ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
            <form method="POST" action="{{ url_for('set_config_path') }}" class="path-form">
                <input type="hidden" name="path_type" value="server">
                <div class="input-group">
                    <input type="text" name="path" value="{{ current_server_path }}" placeholder="/etc/wireguard/wg0.conf" class="form-control">
                    <button type="button" onclick="browseForPath('server')" class="btn btn-outline">–û–±–∑–æ—Ä</button>
                    <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
                <small class="help-text">–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: /etc/wireguard/wg0.conf)</small>
            </form>
        </div>
    </div>

    <div class="actions">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–ª–∏–µ–Ω—Ç–æ–≤</a>
        <a href="{{ url_for('browse_directory') }}" class="btn btn-primary">üóÇÔ∏è –û–±–∑–æ—Ä —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã</a>
    </div>
</div>

<style>
.config-section {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
}

.current-paths {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.path-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    flex-wrap: wrap;
}

.path-item code {
    background: var(--bg-primary);
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    flex: 1;
    min-width: 200px;
}

.path-config {
    margin-bottom: 24px;
}

.path-config h3 {
    margin-bottom: 12px;
    color: var(--text-primary);
}

.input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.form-control {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-family: 'Courier New', monospace;
}

.help-text {
    color: var(--text-muted);
    font-size: 0.9em;
}

.quick-scan {
    text-align: center;
}

.scan-results {
    margin-top: 16px;
    padding: 16px;
    background: var(--bg-tertiary);
    border-radius: 8px;
    display: none;
}

.scan-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.scan-result-item:last-child {
    border-bottom: none;
}

.actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 32px;
}

@media (max-width: 768px) {
    .path-item {
        flex-direction: column;
        align-items: stretch;
    }
    
    .input-group {
        flex-direction: column;
    }
    
    .actions {
        flex-direction: column;
    }
}
</style>

<script>
function browseForPath(type) {
    const currentPath = type === 'client' ? '{{ current_client_path }}' : '{{ current_server_path|dirname }}';
    window.open(`{{ url_for('browse_directory') }}?path=${encodeURIComponent(currentPath)}`, '_blank');
}

function scanCommonPaths() {
    const resultsDiv = document.getElementById('scan-results');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="loading">üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';
    
    const commonPaths = ['/root', '/etc/wireguard', '/home', '/opt/wireguard', '/var/lib/wireguard'];
    
    Promise.all(commonPaths.map(path => 
        fetch(`{{ url_for('scan_configs_in_path') }}?path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .catch(() => ({error: `–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ ${path}`}))
    )).then(results => {
        let html = '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>';
        
        results.forEach((result, index) => {
            const path = commonPaths[index];
            if (result.error) {
                html += `<div class="scan-result-item">
                    <span>‚ùå ${path}</span>
                    <span class="text-muted">${result.error}</span>
                </div>`;
            } else if (result.count > 0) {
                html += `<div class="scan-result-item">
                    <span>‚úÖ ${path}</span>
                    <span>–ù–∞–π–¥–µ–Ω–æ: ${result.count} –∫–æ–Ω—Ñ–∏–≥–æ–≤</span>
                    <button onclick="setPath('${path}', 'client')" class="btn btn-sm btn-success">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                </div>`;
            } else {
                html += `<div class="scan-result-item">
                    <span>üìÅ ${path}</span>
                    <span class="text-muted">–ö–æ–Ω—Ñ–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>
                </div>`;
            }
        });
        
        resultsDiv.innerHTML = html;
    });
}

function setPath(path, type) {
    const form = document.querySelector(`form input[name="path_type"][value="${type}"]`).closest('form');
    form.querySelector('input[name="path"]').value = type === 'client' ? path + '/' : path;
}
</script>
{% endblock %}